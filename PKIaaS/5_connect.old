#!/bin/bash -ex

# Determine which extra services should be loaded when working with authenticators
USAGE=true
RESTART_SERVER=false
INCLUDE_CERT_CHAIN=false
INCLUDE_CLIENT_CERT=false
while [ ! -z "$1" ] ; do
  USAGE=false
  case "$1" in
    --restart-server ) RESTART_SERVER=true ; shift ;;
    --ca-chain ) INCLUDE_CERT_CHAIN=true ; shift ;;
    --client-cert ) INCLUDE_CLIENT_CERT=true ; shift ;;
     * ) USAGE=true; shift ;;
  esac
done

if [[ $USAGE = true ]]; then
  printf "\nUsage: %s [--restart-server] [--ca-chain] [--client-cert] \n\n" $0
  exit -1
fi

if [[ $RESTART_SERVER == true ]]; then
  echo "Starting server..."
  docker-compose rm -fs server >& /dev/null
  docker-compose up -d server >& /dev/null
fi

ca_args=""
if [[ $INCLUDE_CERT_CHAIN = true ]]; then
  ca_args="--cacert \$MTLS_CA_CHAIN"
fi

client_args=""
if [[ $INCLUDE_CLIENT_CERT = true ]]; then
  client_args="--cert \$MTLS_CERT --key \$MTLS_PRIVATE_KEY"
fi

echo
echo "Connecting client (Certificate Chain=$INCLUDE_CERT_CHAIN, Client Certificate=$INCLUDE_CLIENT_CERT)..."
echo
docker-compose run --rm client bash -c "summon -f /etc/secrets.yml ./connect.sh"
echo
echo
